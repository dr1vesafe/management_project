{% extends "base.html" %}

{% block title %}Команда{% endblock %}

{% block content %}
<body>
<div class="container mt-5">
  <h2 class="mb-4">Команда: {{ team.name }}</h2>
  <h5 class="mb-4">Средняя оценка команды: {{ avg_grade }}</h5>
  {% if members %}
    <div class="list-group">
      {% for member in members %}
        <div class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ member.first_name or "-" }} {{ member.last_name or "-" }}</strong> ({{ member.email }})
            {% if user.role == 'admin' and member.id != user.id %}
            {% if member.role.name == 'user' %}
            <form action="/teams/{{ team.id }}/users/{{ member.id }}/promote" method="post" 
                  onsubmit="return confirm('Вы уверены, что хотите повысить роль этого пользователя до менеджера?');"
                  style="display:inline">
                <button type="submit" class="btn btn-success btn-sm">Повысить</button>
            </form>
            {% endif %}
            {% if member.role.name == 'manager' %}
            <form action="/teams/{{ team.id }}/users/{{ member.id }}/downgrade" method="post" 
                  onsubmit="return confirm('Вы уверены, что хотите понизить роль этого пользователя?');"
                  style="display:inline">
                <button type="submit" class="btn btn-success btn-sm">Понизить</button>
            </form>
            {% endif %}
            <form action="/teams/{{ team.id }}/users/{{ member.id }}/remove" method="post"
            onsubmit="return confirm('Вы уверены, что хотите удалить пользователя из команды?');"
            style="display:inline">
            <button type="submit" class="btn btn-danger btn-sm">Удалить</button>
          </form>
          {% endif %}
        </div>
          <span class="badge bg-primary rounded-pill">{{ member.role.value if member.role else "-" }}</span>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p>В команде пока нет участников.</p>
  {% endif %}
  <h5 class="mb-4">Код: {{ team.code }}</h5>
  <div class="d-flex gap-2 mt-4">
    {% if user.role == "admin" %}
    <a href="/teams/{{ team.id }}/edit" class="btn btn-primary">Изменить команду</a>
    <form action="/teams/{{ team.id }}/code" method="post" onsubmit="return confirm('Вы уверены, что хотите изменить код?');">
      <button type="submit" class="btn btn-primary">Сгенерировать новый код</button>
    </form>
    <form action="/teams/{{ team.id }}/delete" method="post" onsubmit="return confirm('Вы уверены, что хотите удалить команду?');">
      <button type="submit" class="btn btn-danger">Удалить команду</button>
    </form>
    {% endif %}
    <form action="/teams/leave-team" method="post" onsubmit="return confirm('Вы уверены, что хотите покинуть команду?');">
      <button type="submit" class="btn btn-danger">Выйти из команды</button>
    </form>
  </div>

</div>
</body>
{% endblock %}